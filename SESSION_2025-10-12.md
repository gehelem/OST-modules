# Session de Debug - 2025-10-12

## Problème Initial
Le sequencer demandait bien l'autofocus au module focus lors d'un changement de filtre, et le focus démarrait correctement, **MAIS** le sequencer n'attendait pas la fin du focus et passait immédiatement à la ligne suivante de la séquence.

## Diagnostic

### Analyse des Logs
```
[2025-10-12T12:48:43.692] Filter changed from Luminance to H_Alpha
[2025-10-12T12:48:43.692] Filter changed - requesting autofocus from module: Focus2
[2025-10-12T12:48:43.695] Autofocus requested by another module - starting
[...focus tourne pendant 17 secondes...]
[2025-10-12T12:48:45.725] Sequence completed  ← PROBLÈME ICI !
[...focus continue...]
[2025-10-12T12:49:00.726] Focus done
```

Le sequencer terminait la séquence **pendant** que le focus était encore en cours.

### Bugs Identifiés

#### Bug #1 : Le sequencer avançait sans attendre le focus
**Fichier** : `OST-modules/src/modules/sequencer/sequencer.cpp`
**Ligne** : 133-141 (fonction `newBLOB()`)

**Problème** : Quand une ligne de séquence se terminait (`currentCount == 0`), le code appelait immédiatement `StartLine()` pour passer à la ligne suivante, **sans vérifier** si on attendait la fin du focus.

**Scénario** :
1. Ligne 1 (Luminance, 1 image) termine → `currentCount = 0`
2. `newBLOB()` appelle `StartLine()`
3. `StartLine()` détecte changement de filtre → demande focus → `mWaitingForFocus = true` → `return`
4. Mais `currentLine` a déjà été incrémenté !
5. Prochaine ligne n'existe pas → "Sequence completed"

**Solution** :
```cpp
if(currentCount == 0)
{
    // Don't start next line if waiting for focus to complete
    if (!mWaitingForFocus)
    {
        StartLine();
    }
}
```

#### Bug #2 : Le sequencer traitait les images du focus
**Fichier** : `OST-modules/src/modules/sequencer/sequencer.cpp`
**Ligne** : 102-106 (fonction `newBLOB()`)

**Problème** : Le sequencer recevait et traitait **toutes** les images de la caméra, y compris les 10+ images prises par le module focus pendant sa procédure d'autofocus. Cela pouvait causer des effets de bord (décrémentation de `currentCount`, appels à `StartLine()`, etc.).

**Solution** :
```cpp
if (
    (QString(pblob.getDeviceName()) == getString("devices", "camera"))
    && isSequenceRunning
    && !mWaitingForFocus  // Don't process images while focus is running
)
```

#### Bug #3 : L'événement focusdone n'était pas émis (hypothétique, non confirmé)
**Fichier** : `OST-modules/src/modules/focus/focus.cpp`
**Ligne** : 565-592 (fonction `SMFocusDone()`)

**Problème potentiel** : Dans la version originale, `pMachine->stop()` était appelé AVANT l'émission de l'événement. Si `stop()` interrompait l'exécution de la fonction (onExit handler), l'événement n'aurait jamais été émis.

**Solution** : Déplacer `pMachine->stop()` APRÈS l'émission de l'événement :
```cpp
emit moduleEvent("focusdone", getModuleName(), "results", eventData);

// Stop state machine AFTER emitting the event
pMachine->stop();
```

## Modifications Apportées

### 1. Sequencer (OST-modules/src/modules/sequencer/sequencer.cpp)

**Ligne 105** : Ajout condition pour ignorer images pendant focus
```cpp
void Sequencer::newBLOB(INDI::PropertyBlob pblob)
{
    if (
        (QString(pblob.getDeviceName()) == getString("devices", "camera"))
        && isSequenceRunning
        && !mWaitingForFocus  // ← AJOUTÉ
    )
```

**Ligne 137-141** : Ne pas avancer si on attend le focus
```cpp
if(currentCount == 0)
{
    // Don't start next line if waiting for focus to complete
    if (!mWaitingForFocus)  // ← AJOUTÉ
    {
        StartLine();
    }
}
```

### 2. Focus (OST-modules/src/modules/focus/focus.cpp)

**Ligne 588-591** : Émettre l'événement AVANT d'arrêter la state machine
```cpp
emit moduleEvent("focusdone", getModuleName(), "results", eventData);

// Stop state machine AFTER emitting the event
pMachine->stop();  // ← DÉPLACÉ APRÈS emit
```

## Workflow Final Corrigé

```
1. Sequencer termine ligne 1 (Luminance, 1 image)
   ↓
2. currentCount = 0, mWaitingForFocus = false
   ↓
3. newBLOB() vérifie !mWaitingForFocus → appelle StartLine()
   ↓
4. StartLine() incrémente currentLine, détecte changement filtre
   ↓
5. StartLine() change filtre physique, met mWaitingForFocus = true
   ↓
6. StartLine() émet requestautofocus → return (ne shoot PAS)
   ↓
7. Focus reçoit requestautofocus → startCoarse()
   ↓
8. Focus prend 10+ images pour trouver la meilleure position
   ↓
9. newBLOB() reçoit ces images MAIS les ignore (mWaitingForFocus = true)
   ↓
10. Focus termine → SMFocusDone() émet focusdone → pMachine->stop()
   ↓
11. Sequencer reçoit focusdone dans OnMyExternalEvent()
   ↓
12. OnFocusDone() met mWaitingForFocus = false
   ↓
13. OnFocusDone() appelle Shoot() → première image de la ligne H_Alpha
   ↓
14. Séquence continue normalement
```

## Tests de Diagnostic Effectués

Pour identifier le problème, j'ai ajouté temporairement des logs de debug :

**Sequencer (ligne 36)** :
```cpp
sendMessage(QString("DEBUG RCV: type='%1' module='%2' key='%3' waiting=%4")
    .arg(eventType).arg(eventModule).arg(eventKey).arg(mWaitingForFocus));
```

**Focus (ligne 588)** :
```cpp
sendMessage(QString("DEBUG EMIT: focusdone to all modules (module='%1')").arg(getModuleName()));
```

Ces logs ont révélé que :
- Le sequencer recevait bien tous les événements du focus (type='se', type='ap', etc.)
- MAIS l'événement focusdone n'était jamais émis (pas de "DEBUG EMIT" dans les logs)
- Le sequencer passait à "Sequence completed" avant la fin du focus

**Ces logs de debug ont été retirés après identification du problème.**

## Fichiers Modifiés

1. `OST-modules/src/modules/sequencer/sequencer.cpp`
   - Ligne 105 : Ajout `&& !mWaitingForFocus` dans condition newBLOB()
   - Ligne 137-141 : Ajout `if (!mWaitingForFocus)` avant StartLine()

2. `OST-modules/src/modules/focus/focus.cpp`
   - Ligne 588-591 : Déplacement de `pMachine->stop()` après `emit moduleEvent()`

## Compilation

```bash
cd /home/gilles/claude/OST/OST-modules/build
make ostsequencer
make ostfocus
sudo cp libostsequencer.so /usr/lib/
sudo cp libostfocus.so /usr/lib/
```

## Tests à Effectuer

Pour valider la correction :

1. Créer une séquence avec au moins 2 lignes :
   - Ligne 1 : Filtre Luminance, 1 image, type Light
   - Ligne 2 : Filtre H_Alpha, 2+ images, type Light

2. Activer `autofocusonfilterchange = true` dans les paramètres du sequencer

3. Configurer `focusmodule = "Focus2"` (ou le nom de ton instance focus)

4. Lancer la séquence et observer :
   - ✓ Message "Filter changed from Luminance to H_Alpha"
   - ✓ Message "Filter changed - requesting autofocus from module: Focus2"
   - ✓ Message "Autofocus requested by another module - starting"
   - ✓ Focus tourne (10+ images)
   - ✓ Message "Focus done"
   - ✓ Message "Autofocus completed - resuming sequence"
   - ✓ Première image H_Alpha shootée
   - ✓ Séquence continue avec les images H_Alpha restantes

5. **IMPORTANT** : Vérifier que "Sequence completed" n'apparaît QUE quand toutes les lignes sont terminées

## Points d'Attention

### Cas Limites à Tester

1. **Séquence d'une seule ligne** : Vérifier que si la séquence n'a qu'une ligne, elle se termine correctement sans attendre de focus

2. **Pas de changement de filtre** : Si toutes les lignes utilisent le même filtre, aucun autofocus ne devrait être déclenché

3. **autofocusonfilterchange = false** : Même avec changement de filtre, aucun autofocus ne devrait être déclenché

4. **Type de frame DARK ou BIAS** : Ces types ne devraient pas déclencher d'autofocus (condition : `currentFrameType == "L" || currentFrameType == "F"`)

5. **Abort pendant focus** : Si l'utilisateur appuie sur "abortsequence" pendant que le focus tourne, vérifier que `mWaitingForFocus` est remis à `false` (déjà implémenté ligne 62 du sequencer)

6. **Module focus inexistant** : Si `focusmodule` pointe vers un module qui n'existe pas, l'événement `requestautofocus` sera perdu silencieusement et le sequencer restera bloqué dans `mWaitingForFocus = true` → **À CORRIGER dans une version future avec timeout**

## Améliorations Futures

### Court Terme
- [ ] Ajouter un **timeout** (ex: 5 minutes) pour l'autofocus. Si le focus ne répond pas, débloquer le sequencer avec un message d'erreur
- [ ] Vérifier l'existence du module focus avant d'émettre `requestautofocus`
- [ ] Ajouter un indicateur visuel dans l'UI : "Waiting for autofocus..."

### Moyen Terme
- [ ] Support de retry : si le focus échoue, réessayer automatiquement (max 3×)
- [ ] Statistiques : logger le temps d'autofocus moyen, taux de succès/échec
- [ ] Permettre à l'utilisateur de skip l'autofocus en cours (bouton "Skip Focus")

### Long Terme
- [ ] Prédiction d'offset focus par filtre (modèle ML basé sur historique)
- [ ] Support multi-instances focus avec load balancing
- [ ] Focus asynchrone (overlapping avec download image pour gagner du temps)

## Documentation à Mettre à Jour

Mettre à jour les fichiers suivants avec les corrections de bugs :

1. **OST-modules/RESUME_SESSION.md**
   - Ajouter section "Session 2025-10-12 : Correction bug attente focus"
   - Documenter les 3 bugs identifiés et corrigés

2. **OST-modules/SEQUENCER_IMPROVEMENTS.md**
   - Section "Bugs Connus" → "Bugs Corrigés"
   - Ajouter workflow détaillé avec les nouvelles conditions

3. **OST/CLAUDE.md**
   - Pas de modification nécessaire (l'architecture générale n'a pas changé)

## Résumé pour Reprise de Session

### Statut Actuel
✅ Autofocus sur changement de filtre : **IMPLÉMENTÉ ET DEBUGGÉ**
✅ Communication inter-modules : **FONCTIONNELLE**
✅ Synchronisation sequencer/focus : **CORRIGÉE**

### Ce qui fonctionne
- Détection de changement de filtre
- Demande d'autofocus au bon module
- Focus démarre correctement
- **NOUVEAU** : Sequencer attend la fin du focus
- **NOUVEAU** : Sequencer ignore les images du focus
- Séquence reprend après focus

### Ce qui reste à faire (optionnel)
- Tests approfondis dans conditions réelles
- Ajout d'un timeout pour éviter blocage
- Validation du nom du module focus avant émission événement
- Indicateur UI "Waiting for focus"

### Commandes de Compilation
```bash
# Si modifications nécessaires
cd /home/gilles/claude/OST/OST-modules/build
make ostsequencer
make ostfocus
sudo cp libostsequencer.so /usr/lib/
sudo cp libostfocus.so /usr/lib/

# Relancer ostserver
# (commande dépend de ton setup)
```

---

**Date** : 2025-10-12
**Développeurs** : Claude Code + Gilles
**Version Sequencer** : 0.2
**Version Focus** : 0.1
**Statut** : ✅ Corrections appliquées, en attente de tests approfondis
